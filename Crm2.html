<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>CRM Ù…Ø¹ ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø§Øª ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial;
      direction: rtl;
      margin: 20px;
      background: #f9f9f9;
    }
    input, select, button {
      margin: 5px 0;
      padding: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    button {
      cursor: pointer;
    }
    h3 {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h2>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª UTM ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
  <div>
    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:
      <input id="clientName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
    </label>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
      <input id="clientPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
    </label>
    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„:
      <select id="clientStatus">
        <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
        <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</option>
        <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
      </select>
    </label>
    <h3>Ù…Ø¹Ø·ÙŠØ§Øª UTM (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹)</h3>
    <label>utm_source:
      <input id="utm_source" placeholder="Ù…Ø«Ù„Ø§Ù‹ facebook" />
    </label>
    <label>utm_medium:
      <input id="utm_medium" placeholder="Ù…Ø«Ù„Ø§Ù‹ cpc" />
    </label>
    <label>utm_campaign:
      <input id="utm_campaign" placeholder="Ù…Ø«Ù„Ø§Ù‹ summer2025" />
    </label>
    <label>utm_content:
      <input id="utm_content" placeholder="Ù…Ø«Ù„Ø§Ù‹ banner1" />
    </label>
    <label>utm_term:
      <input id="utm_term" placeholder="Ù…Ø«Ù„Ø§Ù‹ shoes" />
    </label>
    <button onclick="addClient()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <button onclick="exportClients()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¥Ù„Ù‰ Excel</button>
  </div>

  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
  <table id="clientsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>utm_source</th>
        <th>utm_medium</th>
        <th>utm_campaign</th>
        <th>utm_content</th>
        <th>utm_term</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø§Øª</h3>
  <table id="campaignReportTable">
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø© (utm_campaign)</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // Ø­ÙØ¸ Ù…Ø¹Ø·ÙŠØ§Øª UTM Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ localStorage
  function saveUTMFromURL() {
    const params = new URLSearchParams(window.location.search);
    ['utm_source','utm_medium','utm_campaign','utm_content','utm_term'].forEach(key => {
      const val = params.get(key);
      if (val) localStorage.setItem(key, val);
    });
  }
  saveUTMFromURL();

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB
  const db = new Dexie("SimpleCRM");
  db.version(1).stores({
    clients: "++id, name, phone, status, utm_source, utm_medium, utm_campaign, utm_content, utm_term"
  });

  // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø·ÙŠØ§Øª UTM Ù…Ù† localStorage ÙˆØªØ¹Ø¨Ø¦ØªÙ‡Ø§
  window.onload = () => {
    ['utm_source','utm_medium','utm_campaign','utm_content','utm_term'].forEach(key => {
      const val = localStorage.getItem(key);
      if (val) document.getElementById(key).value = val;
    });
    displayClients();
    displayCampaignReport();
  };

  // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
  async function addClient() {
    const name = document.getElementById("clientName").value.trim();
    const phone = document.getElementById("clientPhone").value.trim();
    const status = document.getElementById("clientStatus").value;
    if (!name || !phone) {
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
      return;
    }

    const clientData = {
      name,
      phone,
      status,
      utm_source: document.getElementById("utm_source").value.trim(),
      utm_medium: document.getElementById("utm_medium").value.trim(),
      utm_campaign: document.getElementById("utm_campaign").value.trim(),
      utm_content: document.getElementById("utm_content").value.trim(),
      utm_term: document.getElementById("utm_term").value.trim(),
    };

    await db.clients.add(clientData);
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    clearForm();
    displayClients();
    displayCampaignReport();
  }

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
  function clearForm() {
    document.getElementById("clientName").value = "";
    document.getElementById("clientPhone").value = "";
    document.getElementById("clientStatus").value = "Ø¬Ø¯ÙŠØ¯";
    ['utm_source','utm_medium','utm_campaign','utm_content','utm_term'].forEach(key => {
      document.getElementById(key).value = "";
    });
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
  async function displayClients() {
    const clients = await db.clients.toArray();
    const tbody = document.querySelector("#clientsTable tbody");
    tbody.innerHTML = "";
    clients.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.status}</td>
        <td>${c.utm_source || ""}</td>
        <td>${c.utm_medium || ""}</td>
        <td>${c.utm_campaign || ""}</td>
        <td>${c.utm_content || ""}</td>
        <td>${c.utm_term || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ø­Ø³Ø¨ utm_campaign
  async function displayCampaignReport() {
    const clients = await db.clients.toArray();
    const report = {};
    clients.forEach(c => {
      const camp = c.utm_campaign || "(ØºÙŠØ± Ù…Ø­Ø¯Ø¯)";
      report[camp] = (report[camp] || 0) + 1;
    });

    const tbody = document.querySelector("#campaignReportTable tbody");
    tbody.innerHTML = "";
    for (const [camp, count] of Object.entries(report)) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${camp}</td><td>${count}</td>`;
      tbody.appendChild(tr);
    }
  }

  // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¥Ù„Ù‰ Excel
  async function exportClients() {
    const clients = await db.clients.toArray();
    if (clients.length === 0) {
      alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
      return;
    }
    const exportData = clients.map(({id, ...rest}) => rest);
    const worksheet = XLSX.utils.json_to_sheet(exportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡");
    XLSX.writeFile(workbook, "clients.xlsx");
  }
</script>
</body>
</html>
