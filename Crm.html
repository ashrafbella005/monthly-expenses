<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ù†Ø¸Ø§Ù… CRM Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØªØ¨Ø¹ UTM ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    margin: 20px auto;
    max-width: 1000px;
  }
  h1, h2 {
    text-align: center;
  }
  label {
    display: block;
    margin-top: 10px;
  }
  input, select, textarea, button {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }
  th {
    background: #007acc;
    color: white;
  }
  .actions button {
    margin: 2px;
    padding: 5px 10px;
  }
  #alerts {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
    padding: 10px;
    margin-top: 20px;
    border-radius: 4px;
  }
  #charts {
    display: flex;
    gap: 20px;
    margin-top: 30px;
    flex-wrap: wrap;
    justify-content: center;
  }
  canvas {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .export-btns {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: center;
  }
</style>
</head>
<body>

<h1>Ù†Ø¸Ø§Ù… CRM Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ ØªØªØ¨Ø¹ UTM ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h1>

<section>
  <h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„</h2>
  <form id="clientForm">
    <input type="hidden" id="clientId" />
    <label>Ø§Ù„Ø§Ø³Ù…:
      <input type="text" id="name" required />
    </label>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:
      <input type="tel" id="phone" required />
    </label>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:
      <input type="email" id="email" />
    </label>
    <label>Ø§Ù„Ø­Ø§Ù„Ø©:
      <select id="status">
        <option value="Ù…Ù‡ØªÙ…">Ù…Ù‡ØªÙ…</option>
        <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</option>
        <option value="ØªÙ… Ø§Ù„Ø¨ÙŠØ¹">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</option>
        <option value="ØºÙŠØ± Ù…Ù‡ØªÙ…">ØºÙŠØ± Ù…Ù‡ØªÙ…</option>
      </select>
    </label>
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
      <textarea id="notes" rows="3"></textarea>
    </label>
    <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
  </form>
</section>

<section id="alerts" style="display:none;"></section>

<section>
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
  <input type="text" id="search" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡..." />
  <table id="clientsTable" >
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ ØªÙˆØ§ØµÙ„</th>
        <th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
        <th>Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (UTM)</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="export-btns">
    <button onclick="exportToExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
  </div>
</section>

<section>
  <h2>ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h2>
  <div id="charts">
    <canvas id="utmCampaignChart" width="400" height="300"></canvas>
    <canvas id="clientsStatusChart" width="400" height="300"></canvas>
  </div>
  <div class="export-btns">
    <button onclick="exportReportToExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
  </div>
</section>

<script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Dexie.js
  const db = new Dexie("CRM_DB");
  db.version(1).stores({
    clients: '++id, name, phone, email, status, notes, firstContact, lastUpdate, utm_source, utm_medium, utm_campaign, utm_content, utm_term'
  });

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ UTM Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ localStorage Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø©
  function saveUTMParams() {
    const params = new URLSearchParams(window.location.search);
    const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'];
    let saved = false;
    utmKeys.forEach(key => {
      if(params.get(key)) {
        localStorage.setItem(key, params.get(key));
        saved = true;
      }
    });
    return saved;
  }
  saveUTMParams();

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª UTM Ù…Ù† localStorage
  function getStoredUTM() {
    return {
      utm_source: localStorage.getItem('utm_source') || '',
      utm_medium: localStorage.getItem('utm_medium') || '',
      utm_campaign: localStorage.getItem('utm_campaign') || '',
      utm_content: localStorage.getItem('utm_content') || '',
      utm_term: localStorage.getItem('utm_term') || '',
    };
  }

  // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù… ÙŠØ­Ø¯Ø« Ù„Ù‡Ù… ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø° 7 Ø£ÙŠØ§Ù… ÙˆÙ…Ø§ ÙÙˆÙ‚ ÙÙŠ Ø­Ø§Ù„Ø© Ù…Ù‡ØªÙ… Ø£Ùˆ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©)
  async function showAlerts() {
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const clients = await db.clients.filter(c => 
      (c.status === "Ù…Ù‡ØªÙ…" || c.status === "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©") && 
      new Date(c.lastUpdate) < sevenDaysAgo
    ).toArray();

    const alertsDiv = document.getElementById('alerts');
    if(clients.length === 0) {
      alertsDiv.style.display = "none";
      alertsDiv.innerHTML = "";
      return;
    }
    alertsDiv.style.display = "block";
    alertsDiv.innerHTML = `<strong>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø©: ${clients.length} Ø¹Ù…ÙŠÙ„ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©.</strong><br>`;
    clients.forEach(c => {
      alertsDiv.innerHTML += `â€¢ ${c.name} (${c.phone}) Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date(c.lastUpdate).toLocaleDateString()}<br>`;
    });
  }

  // Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„
  const form = document.getElementById('clientForm');
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('clientId').value;
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const status = document.getElementById('status').value;
    const notes = document.getElementById('notes').value.trim();

    if(!name || !phone) {
      alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");
      return;
    }

    const utm = getStoredUTM();

    const now = new Date().toISOString();
    if(id) {
      // ØªØ¹Ø¯ÙŠÙ„
      await db.clients.update(parseInt(id), {
        name, phone, email, status, notes,
        lastUpdate: now
      });
    } else {
      // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
      await db.clients.add({
        name, phone, email, status, notes,
        firstContact: now,
        lastUpdate: now,
        ...utm
      });
    }
    form.reset();
    document.getElementById('clientId').value = "";
    loadClients();
    showAlerts();
    updateCharts();
  });

  // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  async function loadClients() {
    let clients = await db.clients.toArray();
    const search = document.getElementById('search').value.trim().toLowerCase();
    if(search) {
      clients = clients.filter(c => 
        c.name.toLowerCase().includes(search) || 
        c.phone.includes(search) || 
        (c.email && c.email.toLowerCase().includes(search)) ||
        (c.status && c.status.toLowerCase().includes(search))
      );
    }
    const tbody = document.querySelector('#clientsTable tbody');
    tbody.innerHTML = "";
    clients.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.email || "-"}</td>
        <td>${c.status}</td>
        <td>${new Date(c.firstContact).toLocaleDateString()}</td>
        <td>${new Date(c.lastUpdate).toLocaleDateString()}</td>
        <td>${c.utm_source ? escapeHTML(c.utm_source) : "-"}</td>
        <td class="actions">
          <button onclick="editClient(${c.id})">âœï¸</button>
          <button onclick="deleteClient(${c.id})">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Ø¯Ø§Ù„Ø© ØªÙ‡Ø±ÙŠØ¨ HTML Ù„Ù…Ù†Ø¹ XSS ÙÙŠ Ø¹Ø±Ø¶ UTM
  function escapeHTML(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„ - ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  async function editClient(id) {
    const client = await db.clients.get(id);
    if(!client) return;
    document.getElementById('clientId').value = client.id;
    document.getElementById('name').value = client.name;
    document.getElementById('phone').value = client.phone;
    document.getElementById('email').value = client.email || "";
    document.getElementById('status').value = client.status;
    document.getElementById('notes').value = client.notes || "";
    window.scrollTo({top: 0, behavior: 'smooth'});
  }

  // Ø­Ø°Ù Ø¹Ù…ÙŠÙ„ Ù…Ø¹ ØªØ£ÙƒÙŠØ¯
  async function deleteClient(id) {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
      await db.clients.delete(id);
      loadClients();
      showAlerts();
      updateCharts();
    }
  }

  // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­ÙŠ
  document.getElementById('search').addEventListener('input', loadClients);

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
  let utmCampaignChart, clientsStatusChart;
  function updateCharts() {
    db.clients.toArray().then(clients => {
      // Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù…Ù„Ø© UTM
      const campaignCount = {};
      clients.forEach(c => {
        const camp = c.utm_campaign || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        campaignCount[camp] = (campaignCount[camp] || 0) + 1;
      });
      const campaignLabels = Object.keys(campaignCount);
      const campaignData = Object.values(campaignCount);

      // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
      const statusCount = {};
      clients.forEach(c => {
        statusCount[c.status] = (statusCount[c.status] || 0) + 1;
      });
      const statusLabels = Object.keys(statusCount);
      const statusData = Object.values(statusCount);

      // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£ÙˆÙ„
      if(utmCampaignChart) {
        utmCampaignChart.data.labels = campaignLabels;
        utmCampaignChart.data.datasets[0].data = campaignData;
        utmCampaignChart.update();
      } else {
        const ctx1 = document.getElementById('utmCampaignChart').getContext('2d');
        utmCampaignChart = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: campaignLabels,
            datasets: [{
              label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø­Ù…Ù„Ø© UTM',
              data: campaignData,
              backgroundColor: 'rgba(0, 123, 204, 0.7)'
            }]
          },
          options: {
            responsive: false,
            scales: {
              y: { beginAtZero: true, precision: 0 }
            }
          }
        });
      }

      // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ
      if(clientsStatusChart) {
        clientsStatusChart.data.labels = statusLabels;
        clientsStatusChart.data.datasets[0].data = statusData;
        clientsStatusChart.update();
      } else {
        const ctx2 = document.getElementById('clientsStatusChart').getContext('2d');
        clientsStatusChart = new Chart(ctx2, {
          type: 'pie',
          data: {
            labels: statusLabels,
            datasets: [{
              label: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
              data: statusData,
              backgroundColor: [
                '#007bff','#28a745','#ffc107','#dc3545','#6c757d'
              ]
            }]
          },
          options: {
            responsive: false,
          }
        });
      }
    });
  }

  // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¥Ù„Ù‰ Excel Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SheetJS
  async function exportToExcel() {
    const clients = await db.clients.toArray();
    const ws_data = [
      ["Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", "Ø§Ù„Ø­Ø§Ù„Ø©", "ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ ØªÙˆØ§ØµÙ„", "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«", "utm_source", "utm_medium", "utm_campaign", "utm_content", "utm_term"]
    ];
    clients.forEach(c => {
      ws_data.push([
        c.name, c.phone, c.email || "-", c.status, 
        new Date(c.firstContact).toLocaleDateString(),
        new Date(c.lastUpdate).toLocaleDateString(),
        c.utm_source || "-", c.utm_medium || "-", c.utm_campaign || "-", c.utm_content || "-", c.utm_term || "-"
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø¹Ù…Ù„Ø§Ø¡");
    XLSX.writeFile(wb, "CRM_Clients.xlsx");
  }

  // ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel
  async function exportReportToExcel() {
    const clients = await db.clients.toArray();

    // Ø­Ø³Ø§Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ù…Ù„Ø§Øª
    const campaignCount = {};
    clients.forEach(c => {
      const camp = c.utm_campaign || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      campaignCount[camp] = (campaignCount[camp] || 0) + 1;
    });

    // Ø­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const statusCount = {};
    clients.forEach(c => {
      statusCount[c.status] = (statusCount[c.status] || 0) + 1;
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    const ws_data = [
      ["ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"],
      [],
      ["Ø§Ù„Ø­Ù…Ù„Ø©", "Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"],
      ...Object.entries(campaignCount),
      [],
      ["Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„", "Ø§Ù„Ø¹Ø¯Ø¯"],
      ...Object.entries(statusCount)
    ];

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ù…Ù„Ø§Øª");
    XLSX.writeFile(wb, "CRM_AdReport.xlsx");
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
  window.onload = () => {
    loadClients();
    showAlerts();
    updateCharts();
  };
</script>

</body>
</html>
