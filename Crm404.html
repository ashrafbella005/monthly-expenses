<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… CRM ÙˆØ¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      direction: rtl;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 20px;
    }
    h2 {
      background: #0077b6;
      color: white;
      padding: 10px;
    }
    section {
      margin-bottom: 30px;
      background: white;
      padding: 15px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    input, select, button, textarea {
      margin: 5px 0;
      padding: 8px;
      font-size: 14px;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .stat-box {
      background: #caf0f8;
      padding: 15px;
      border-radius: 6px;
      flex: 1;
      text-align: center;
    }
    .alert {
      background: #ffb703;
      padding: 10px;
      color: #000;
      margin-bottom: 10px;
      font-weight: bold;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { background: #ffd166; }
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
<section>
  <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
  <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
  <input id="utm_source" placeholder="UTM Ø§Ù„Ù…ØµØ¯Ø±" />
  <input id="utm_campaign" placeholder="UTM Ø§Ù„Ø­Ù…Ù„Ø©" />
  <input id="follow_date" type="date" />
  <button onclick="addClient()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
  <div id="alerts"></div>
  <table id="clientsTable">
    <thead>
      <tr><th>Ø§Ø³Ù…</th><th>Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ø­Ù…Ù„Ø©</th><th>Ù…ØªØ§Ø¨Ø¹Ø©</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<h2>ğŸ“† Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h2>
<section>
  <select id="platform">
    <option>ÙÙŠØ³Ø¨ÙˆÙƒ</option>
    <option>Ù„ÙŠÙ†ÙƒØ¯ Ø¥Ù†</option>
    <option>ØªÙŠÙƒ ØªÙˆÙƒ</option>
    <option>ÙŠÙˆØªÙŠÙˆØ¨</option>
  </select>
  <input id="budget" type="number" placeholder="Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø¬Ù†ÙŠÙ‡)" />
  <input id="date" type="date" />
  <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
  <button onclick="addAd()">â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</button>
  <table id="adsTable">
    <thead>
      <tr><th>Ù…Ù†ØµØ©</th><th>Ù…ÙŠØ²Ø§Ù†ÙŠØ©</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
<section>
  <div class="stats">
    <div class="stat-box" id="totalClients">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 0</div>
    <div class="stat-box" id="adsCount">ğŸ“£ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: 0</div>
    <div class="stat-box" id="fbCount">ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ: 0</div>
    <div class="stat-box" id="ytCount">â–¶ï¸ ÙŠÙˆØªÙŠÙˆØ¨: 0</div>
  </div>
  <canvas id="chart" height="100"></canvas>
  <button onclick="exportToExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
</section>

<script>
  let clients = JSON.parse(localStorage.getItem("clients") || "[]");
  let ads = JSON.parse(localStorage.getItem("ads") || "[]");

  function renderClients() {
    const tbody = document.querySelector("#clientsTable tbody");
    tbody.innerHTML = "";
    const today = new Date().toISOString().split("T")[0];
    let hasAlert = false;

    clients.forEach(c => {
      const row = `<tr>
        <td>${c.name}</td><td>${c.phone}</td><td>${c.source}</td>
        <td>${c.campaign}</td><td>${c.follow_date}</td>
      </tr>`;
      tbody.innerHTML += row;

      if (c.follow_date === today) hasAlert = true;
    });

    document.getElementById("alerts").innerHTML = hasAlert
      ? `<div class="alert">ğŸš¨ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…!</div>`
      : "";
    if (hasAlert) new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();

    document.getElementById("totalClients").textContent = `ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${clients.length}`;
  }

  function renderAds() {
    const tbody = document.querySelector("#adsTable tbody");
    tbody.innerHTML = "";
    let fb = 0, yt = 0;

    ads.forEach(a => {
      const row = `<tr>
        <td>${a.platform}</td><td>${a.budget}</td>
        <td>${a.date}</td><td>${a.notes}</td>
      </tr>`;
      tbody.innerHTML += row;
      if (a.platform === "ÙÙŠØ³Ø¨ÙˆÙƒ") fb++;
      if (a.platform === "ÙŠÙˆØªÙŠÙˆØ¨") yt++;
    });

    document.getElementById("adsCount").textContent = `ğŸ“£ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: ${ads.length}`;
    document.getElementById("fbCount").textContent = `ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ: ${fb}`;
    document.getElementById("ytCount").textContent = `â–¶ï¸ ÙŠÙˆØªÙŠÙˆØ¨: ${yt}`;
    drawChart();
  }

  function addClient() {
    const c = {
      name: name.value,
      phone: phone.value,
      source: utm_source.value,
      campaign: utm_campaign.value,
      follow_date: follow_date.value
    };
    clients.push(c);
    localStorage.setItem("clients", JSON.stringify(clients));
    renderClients();
    name.value = phone.value = utm_source.value = utm_campaign.value = follow_date.value = "";
  }

  function addAd() {
    const ad = {
      platform: platform.value,
      budget: budget.value,
      date: date.value,
      notes: notes.value
    };
    ads.push(ad);
    localStorage.setItem("ads", JSON.stringify(ads));
    renderAds();
    budget.value = date.value = notes.value = "";
  }

  function drawChart() {
    const platforms = {};
    ads.forEach(ad => platforms[ad.platform] = (platforms[ad.platform] || 0) + 1);
    const ctx = document.getElementById('chart').getContext('2d');
    if (window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(platforms),
        datasets: [{
          label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª',
          data: Object.values(platforms),
          backgroundColor: '#00b4d8'
        }]
      }
    });
  }

  function exportToExcel() {
    const wb = XLSX.utils.book_new();

    const clientSheet = XLSX.utils.json_to_sheet(clients);
    const adSheet = XLSX.utils.json_to_sheet(ads);

    XLSX.utils.book_append_sheet(wb, clientSheet, "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡");
    XLSX.utils.book_append_sheet(wb, adSheet, "Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");

    XLSX.writeFile(wb, "crm_report.xlsx");
  }

  renderClients();
  renderAds();

  // Ù‚Ø±Ø§Ø¡Ø© UTM Ù…Ù† URL Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
  window.addEventListener("load", () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get("utm_source")) {
      utm_source.value = params.get("utm_source");
      utm_campaign.value = params.get("utm_campaign") || "";
    }
  });
</script>
</body>
</html>
