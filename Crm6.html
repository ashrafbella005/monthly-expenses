<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CRM ÙˆØ¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª - Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø©</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { direction: rtl; font-family: Arial; background: #f4f4f4; padding: 20px; }
    section { background: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 5px #ccc; }
    input, button, select, textarea { padding: 8px; margin: 5px 0; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    .alert { background: #ffb703; padding: 10px; font-weight: bold; animation: blink 1s infinite; }
    @keyframes blink { 50% { background: #ffd166; } }
    .stat-box { background: #caf0f8; padding: 10px; margin: 5px; text-align: center; }
    .actions button { margin: 0 5px; }
  </style>
</head>
<body>

<h2>ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
<section>
  <input id="searchClient" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„...">
  <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
  <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
  <input id="utm_source" placeholder="UTM Ø§Ù„Ù…ØµØ¯Ø±" />
  <input id="utm_campaign" placeholder="UTM Ø§Ù„Ø­Ù…Ù„Ø©" />
  <input id="follow_date" type="date" />
  <button onclick="addClient()">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„</button>
  <div id="alerts"></div>
  <table id="clientsTable">
    <thead>
      <tr><th>Ø§Ø³Ù…</th><th>Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ø­Ù…Ù„Ø©</th><th>Ù…ØªØ§Ø¨Ø¹Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<h2>ğŸ“† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h2>
<section>
  <input id="searchAd" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª...">
  <select id="platform"><option>ÙÙŠØ³Ø¨ÙˆÙƒ</option><option>Ù„ÙŠÙ†ÙƒØ¯ Ø¥Ù†</option><option>ØªÙŠÙƒ ØªÙˆÙƒ</option><option>ÙŠÙˆØªÙŠÙˆØ¨</option></select>
  <input id="budget" type="number" placeholder="Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" />
  <input id="date" type="date" />
  <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
  <button onclick="addAd()">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†</button>
  <table id="adsTable">
    <thead>
      <tr><th>Ù…Ù†ØµØ©</th><th>Ù…ÙŠØ²Ø§Ù†ÙŠØ©</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
<section>
  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <div class="stat-box" id="totalClients">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 0</div>
    <div class="stat-box" id="adsCount">ğŸ“£ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: 0</div>
    <div class="stat-box" id="fbCount">ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ: 0</div>
    <div class="stat-box" id="ytCount">â–¶ï¸ ÙŠÙˆØªÙŠÙˆØ¨: 0</div>
  </div>
  <canvas id="chart" height="100"></canvas>
  <button onclick="exportToExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
</section>

<script>
let clients = JSON.parse(localStorage.getItem("clients") || "[]");
let ads = JSON.parse(localStorage.getItem("ads") || "[]");
let editIndexClient = -1, editIndexAd = -1;

function renderClients() {
  const tbody = document.querySelector("#clientsTable tbody");
  tbody.innerHTML = "";
  const today = new Date().toISOString().split("T")[0];
  let hasAlert = false;

  clients.forEach((c, i) => {
    const row = document.createElement("tr");
    if (document.getElementById("searchClient").value && !JSON.stringify(c).includes(document.getElementById("searchClient").value)) return;

    row.innerHTML = `
      <td>${c.name}</td><td>${c.phone}</td><td>${c.source}</td>
      <td>${c.campaign}</td><td>${c.follow_date}</td>
      <td class="actions">
        <button onclick="editClient(${i})">âœï¸</button>
        <button onclick="deleteClient(${i})">ğŸ—‘ï¸</button>
      </td>`;
    tbody.appendChild(row);
    if (c.follow_date === today) hasAlert = true;
  });

  document.getElementById("alerts").innerHTML = hasAlert ? `<div class="alert">ğŸš¨ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…!</div>` : "";
  if (hasAlert) new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
  document.getElementById("totalClients").textContent = `ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${clients.length}`;
}

function addClient() {
  const c = {
    name: name.value,
    phone: phone.value,
    source: utm_source.value,
    campaign: utm_campaign.value,
    follow_date: follow_date.value
  };

  if (editIndexClient >= 0) {
    clients[editIndexClient] = c;
    editIndexClient = -1;
  } else {
    clients.push(c);
  }

  localStorage.setItem("clients", JSON.stringify(clients));
  renderClients();
  name.value = phone.value = utm_source.value = utm_campaign.value = follow_date.value = "";
}

function editClient(i) {
  const c = clients[i];
  name.value = c.name;
  phone.value = c.phone;
  utm_source.value = c.source;
  utm_campaign.value = c.campaign;
  follow_date.value = c.follow_date;
  editIndexClient = i;
}

function deleteClient(i) {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
    clients.splice(i, 1);
    localStorage.setItem("clients", JSON.stringify(clients));
    renderClients();
  }
}

function renderAds() {
  const tbody = document.querySelector("#adsTable tbody");
  tbody.innerHTML = "";
  let fb = 0, yt = 0;

  ads.forEach((a, i) => {
    if (document.getElementById("searchAd").value && !JSON.stringify(a).includes(document.getElementById("searchAd").value)) return;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.platform}</td><td>${a.budget}</td><td>${a.date}</td><td>${a.notes}</td>
      <td class="actions">
        <button onclick="editAd(${i})">âœï¸</button>
        <button onclick="deleteAd(${i})">ğŸ—‘ï¸</button>
      </td>`;
    tbody.appendChild(row);
    if (a.platform === "ÙÙŠØ³Ø¨ÙˆÙƒ") fb++;
    if (a.platform === "ÙŠÙˆØªÙŠÙˆØ¨") yt++;
  });

  document.getElementById("adsCount").textContent = `ğŸ“£ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: ${ads.length}`;
  document.getElementById("fbCount").textContent = `ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ: ${fb}`;
  document.getElementById("ytCount").textContent = `â–¶ï¸ ÙŠÙˆØªÙŠÙˆØ¨: ${yt}`;
  drawChart();
}

function addAd() {
  const ad = {
    platform: platform.value,
    budget: budget.value,
    date: date.value,
    notes: notes.value
  };

  if (editIndexAd >= 0) {
    ads[editIndexAd] = ad;
    editIndexAd = -1;
  } else {
    ads.push(ad);
  }

  localStorage.setItem("ads", JSON.stringify(ads));
  renderAds();
  budget.value = date.value = notes.value = "";
}

function editAd(i) {
  const ad = ads[i];
  platform.value = ad.platform;
  budget.value = ad.budget;
  date.value = ad.date;
  notes.value = ad.notes;
  editIndexAd = i;
}

function deleteAd(i) {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) {
    ads.splice(i, 1);
    localStorage.setItem("ads", JSON.stringify(ads));
    renderAds();
  }
}

function drawChart() {
  const platforms = {};
  ads.forEach(ad => platforms[ad.platform] = (platforms[ad.platform] || 0) + 1);
  const ctx = document.getElementById('chart').getContext('2d');
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(platforms),
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª',
        data: Object.values(platforms),
        backgroundColor: '#00b4d8'
      }]
    }
  });
}

function exportToExcel() {
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clients), "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ads), "Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
  XLSX.writeFile(wb, "crm_report.xlsx");
}

document.getElementById("searchClient").addEventListener("input", renderClients);
document.getElementById("searchAd").addEventListener("input", renderAds);

renderClients();
renderAds();
</script>
</body>
</html>
